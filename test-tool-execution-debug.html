<!DOCTYPE html>
<html>
<head>
    <title>Tool Execution Debug Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        #log {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 10px;
            height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .info { color: #60a5fa; }
        .warning { color: #fbbf24; }
        button {
            margin: 5px;
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #666; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Tool Execution Debug Test</h1>
    <div>
        <button onclick="connect()">Connect</button>
        <button onclick="startSession()">Start Session</button>
        <button onclick="testCheckpoint()">Test Checkpoint</button>
        <button onclick="testRealityCheck()">Test Reality Check</button>
        <button onclick="testOptimize()">Test Optimize</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    <div id="log"></div>

    <script>
        let ws = null;
        let sessionId = null;
        let requestCounter = 0;

        function log(message, type = '') {
            const timestamp = new Date().toISOString().split('T')[1];
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function connect() {
            log('Connecting to WebSocket server...', 'info');
            
            ws = new WebSocket('ws://localhost:8080');
            
            ws.onopen = () => {
                log('WebSocket connected!', 'success');
                log('Sending authentication...', 'info');
                ws.send(JSON.stringify({
                    type: 'authenticate',
                    auth: 'myworkflow-secret'
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    
                    // Log all messages except session.status to reduce spam
                    if (message.type !== 'event' || message.topic !== 'session.status') {
                        log(`Received: ${JSON.stringify(message, null, 2)}`, 'info');
                    }
                    
                    // Handle authentication
                    if (message.type === 'auth' && message.data?.authenticated) {
                        log('Authentication successful! Subscribing to topics...', 'success');
                        
                        // Subscribe to tool:execution events
                        ws.send(JSON.stringify({
                            type: 'subscribe',
                            topic: 'tool:execution'
                        }));
                        log('Subscribed to tool:execution', 'info');
                        
                        // Also subscribe to session status to get session ID
                        ws.send(JSON.stringify({
                            type: 'subscribe',
                            topic: 'session.status'
                        }));
                    }
                    
                    // Extract session ID
                    if (message.type === 'event' && message.topic === 'session.status' && message.data?.session) {
                        sessionId = message.data.session.id;
                        log(`Session ID updated: ${sessionId}`, 'success');
                    }
                    
                    // Highlight tool execution events
                    if (message.type === 'event' && message.topic === 'tool:execution') {
                        log('ðŸŽ¯ TOOL EXECUTION EVENT RECEIVED!', 'success');
                        log(JSON.stringify(message.data, null, 2), 'success');
                    }
                    
                } catch (err) {
                    log(`Error parsing message: ${err.message}`, 'error');
                }
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                log('WebSocket disconnected', 'warning');
                ws = null;
            };
        }

        function sendToolExecution(tool, params) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket not connected!', 'error');
                return;
            }
            
            const requestId = `req_${Date.now()}_${++requestCounter}`;
            
            log(`Sending tool execution: ${tool}`, 'info');
            log(`Request ID: ${requestId}`, 'info');
            log(`Parameters: ${JSON.stringify(params, null, 2)}`, 'info');
            
            ws.send(JSON.stringify({
                type: 'execute',
                tool: tool,
                params: params,
                requestId: requestId
            }));
        }

        function startSession() {
            log('Starting new session...', 'info');
            sendToolExecution('startSession', {
                projectName: 'Debug Test Project',
                type: 'feature',
                estimated_scope: {
                    lines_of_code: 100,
                    test_coverage: 80,
                    documentation: 3
                }
            });
        }

        function testCheckpoint() {
            if (!sessionId) {
                log('No active session! Start a session first.', 'error');
                return;
            }
            
            log(`Testing checkpoint for session ${sessionId}...`, 'info');
            sendToolExecution('createCheckpoint', {
                sessionId: sessionId,
                achievements: ['Debug test checkpoint'],
                linesWritten: 50,
                testsPassing: 5,
                contextUsed: 25
            });
        }

        function testRealityCheck() {
            if (!sessionId) {
                log('No active session! Start a session first.', 'error');
                return;
            }
            
            log(`Testing reality check for session ${sessionId}...`, 'info');
            sendToolExecution('performRealityCheck', {
                sessionId: sessionId,
                checkType: 'quick'
            });
        }

        function testOptimize() {
            if (!sessionId) {
                log('No active session! Start a session first.', 'error');
                return;
            }
            
            log(`Testing context optimization for session ${sessionId}...`, 'info');
            sendToolExecution('optimizeContext', {
                sessionId: sessionId,
                threshold: 0.3
            });
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        // Auto-connect on load
        window.onload = () => {
            log('Page loaded. Click "Connect" to start.', 'info');
        };
    </script>
</body>
</html>